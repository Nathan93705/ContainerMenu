"use strict";var P=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var et=Object.getOwnPropertyNames;var nt=Object.prototype.hasOwnProperty;var i=(r,t)=>P(r,"name",{value:t,configurable:!0});var ot=(r,t)=>{for(var o in t)P(r,o,{get:t[o],enumerable:!0})},rt=(r,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of et(t))!nt.call(r,e)&&e!==o&&P(r,e,{get:()=>t[e],enumerable:!(n=tt(t,e))||n.enumerable});return r};var it=r=>rt(P({},"__esModule",{value:!0}),r);var at={};ot(at,{default:()=>st});module.exports=it(at);var j=require("@serenityjs/plugins");var v=require("@serenityjs/protocol");var p=require("@serenityjs/core");var a=require("@serenityjs/protocol"),b=require("@serenityjs/core"),g=require("@serenityjs/nbt");var I=require("@serenityjs/core");var m;(u=>{u.containerMap=new Map;function t(s,k){s instanceof I.Player&&(s=s.connection),u.containerMap.set(s,k)}u.setContainer=t,i(t,"setContainer");function o(){return Array.from(u.containerMap.values())}u.getAllContainers=o,i(o,"getAllContainers");function n(s){s instanceof I.Player&&(s=s.connection),u.containerMap.delete(s)}u.removeContainer=n,i(n,"removeContainer");function e(s){return s instanceof I.Player&&(s=s.connection),u.containerMap.get(s)}u.getContainer=e,i(e,"getContainer");function c(s){return s instanceof I.Player&&(s=s.connection),u.containerMap.has(s)}u.hasContainer=c,i(c,"hasContainer")})(m||={});function J(r){let t=r.position;return new a.BlockPosition(Math.floor(t.x),Math.floor(t.y+2),Math.floor(t.z))}i(J,"getAbovePosition");var l=class{static{i(this,"FakeContainer")}blockIdentifier;containerId=a.ContainerId.None;containerType;containerSize;inventory;customName;transactionCallback;containerCloseCallback;constructor(t,o,n,e={}){this.blockIdentifier=t,this.containerType=o,this.containerSize=n,this.inventory=e}show(t){if(m.hasContainer(t))throw Error("Player Already Has A Fake Container Open");let o=J(t);this.placeContainer(t,o),this.customName&&this.sendCustomName(t,o),this.openContainer(t,o),t.world.schedule(1).on(()=>this.update(t))}setItem(t,o){if(t<0||t>=this.containerSize)throw new Error(`Slot ${t} is out of range (container has ${this.containerSize} slots)`);this.inventory[t]=o}getItem(t){if(t<0||t>=this.containerSize)throw new Error(`Slot ${t} is out of range (container has ${this.containerSize} slots)`);return this.inventory[t]}addItem(t){for(let o=0;o<this.containerSize;o++)if(!this.inventory[o]){this.setItem(o,t);return}}clearItem(t){if(t<0||t>=this.containerSize)throw new Error(`Slot ${t} is out of range (container has ${this.containerSize} slots)`);this.inventory[t]&&delete this.inventory[t]}setContents(t){for(let[o,n]of Object.entries(t))this.setItem(+o,n)}getContents(){return this.inventory}clearContents(){for(let[t,o]of Object.entries(this.inventory))this.clearItem(+t)}update(t){if(!m.hasContainer(t))throw Error("Player Doesnt Have A Fake Container Open");let o=[];for(let e=0;e<this.containerSize;e++){let c=this.inventory[e]??new b.ItemStack(b.ItemIdentifier.Air),u=b.ItemStack.toNetworkStack(c);o.push(u)}let n=new a.InventoryContentPacket;n.containerId=this.containerId,n.items=o,n.fullContainerName=new a.FullContainerName(a.ContainerName.Container),n.storageItem=new a.NetworkItemStackDescriptor(0),t.send(n)}destroyContainer(t,o){let n=t.dimension.getBlock(o),e=b.BlockPermutation.resolve(n.type.identifier).networkId,c=new a.UpdateBlockPacket;c.position=o,c.networkBlockId=e,c.flags=a.UpdateBlockFlagsType.Network,c.layer=0,c.offset=0,t.send(c)}placeContainer(t,o){let n=b.BlockPermutation.resolve(this.blockIdentifier).networkId,e=new a.UpdateBlockPacket;e.position=o,e.networkBlockId=n,e.flags=0,e.layer=0,e.offset=0,t.send(e)}openContainer(t,o){let n=new a.ContainerOpenPacket;n.identifier=this.containerId,n.type=this.containerType,n.position=o,n.uniqueId=-1n,t.send(n),m.setContainer(t,{blockPos:o,container:this})}closeContainer(t,o=!0){if(!m.hasContainer(t))throw Error("Player Doesnt Have A Fake Container Open");let n=m.getContainer(t),e=new a.ContainerClosePacket;e.identifier=this.containerId,e.serverInitiated=o,e.type=this.containerType,t.send(e),t.world.schedule(1).on(()=>this.destroyContainer(t,n.blockPos)),this.callCloseCallback(t),m.removeContainer(t)}sendCustomName(t,o){let n=new a.BlockActorDataPacket;n.position=o;let e=new g.StringTag({name:"CustomName",value:this.customName});n.nbt||(n.nbt=new g.CompoundTag),n.nbt.addTag(e),t.send(n)}setCustomName(t){this.customName=t}getCustomName(){return this.customName}onTransaction(t){this.transactionCallback=t}callTransactionCallback(t,o){if(this.transactionCallback!==void 0)return this.transactionCallback({action:t,player:o})}onClose(t){this.containerCloseCallback=t}callCloseCallback(t){this.containerCloseCallback!==void 0&&this.containerCloseCallback(t)}};var _=require("@serenityjs/protocol"),C=require("@serenityjs/nbt");var w=class extends l{static{i(this,"FakeDoubleContainer")}constructor(t,o,n,e={}){super(t,o,n,e)}show(t){let o=J(t),n=o;n.x+=1,this.placeContainer(t,o),this.placeContainer(t,n),this.sendNbtData(t,[o,n],!0),this.sendNbtData(t,[o,n],!1),this.openContainer(t,o),t.world.schedule(1).on(()=>this.update(t))}sendNbtData(t,o,n=!1){let e=new _.BlockActorDataPacket;e.position=n?o[0]:o[1];let c={};e.nbt||(e.nbt=new C.CompoundTag);let u=this.getCustomName();u&&(c.CustomName=new C.StringTag({name:"CustomName",value:u})),c.pairlead=new C.ByteTag({name:"pairlead",value:n?1:0}),c.pairx=new C.IntTag({name:"pairx",value:o[0].x}),c.pairz=new C.IntTag({name:"pairz",value:o[1].z});for(let[s,k]of Object.entries(c))e.nbt.addTag(k);t.send(e)}destroyContainer(t,o){let n=o,e=n;e.x+=1,this.destroyContainer(t,n),this.destroyContainer(t,e)}};var d=require("@serenityjs/protocol");var B=class extends l{static{i(this,"TrappedChestContainer")}constructor(t){super(p.BlockIdentifier.TrappedChest,d.ContainerType.Container,27,t)}},D=class extends l{static{i(this,"ChestContainer")}constructor(t){super(p.BlockIdentifier.Chest,d.ContainerType.Container,27,t)}},y=class extends l{static{i(this,"DispenserContainer")}constructor(t){super(p.BlockIdentifier.Dispenser,d.ContainerType.Dispenser,9,t)}},A=class extends l{static{i(this,"DropperContainer")}constructor(t){super(p.BlockIdentifier.Dropper,d.ContainerType.Dropper,9,t)}},E=class extends l{static{i(this,"EnchantingContainer")}constructor(t){super(p.BlockIdentifier.EnchantingTable,d.ContainerType.Enchantment,2,t)}},N=class extends l{static{i(this,"HopperContainer")}constructor(t){super(p.BlockIdentifier.Hopper,d.ContainerType.Hopper,5,t)}},T=class extends l{static{i(this,"CraftingContainer")}constructor(t){super(p.BlockIdentifier.CraftingTable,d.ContainerType.Workbench,10,t)}},O=class extends l{static{i(this,"SmithingContainer")}constructor(t){super(p.BlockIdentifier.SmithingTable,d.ContainerType.SmithingTable,4,t)}},q=class extends l{static{i(this,"FurnaceContainer")}constructor(t){super(p.BlockIdentifier.Furnace,d.ContainerType.Furnace,3,t)}},M=class extends l{static{i(this,"SmokerContainer")}constructor(t){super(p.BlockIdentifier.Smoker,d.ContainerType.Smoker,3,t)}},R=class extends l{static{i(this,"BlastFurnaceContainer")}constructor(t){super(p.BlockIdentifier.BlastFurnace,d.ContainerType.BlastFurnace,3,t)}},H=class extends l{static{i(this,"AnvilContainer")}constructor(t){super(p.BlockIdentifier.Anvil,d.ContainerType.Anvil,3,t)}},$=class extends l{static{i(this,"BrewingStandContainer")}constructor(t){super(p.BlockIdentifier.BrewingStand,d.ContainerType.BrewingStand,5,t)}},G=class extends l{static{i(this,"GrindstoneContainer")}constructor(t){super(p.BlockIdentifier.Grindstone,d.ContainerType.Grindstone,3,t)}},z=class extends l{static{i(this,"StonecutterContainer")}constructor(t){super(p.BlockIdentifier.Stonecutter,d.ContainerType.Stonecutter,2,t)}},L=class extends w{static{i(this,"DoubleChestContainer")}constructor(t){super(p.BlockIdentifier.Chest,d.ContainerType.Container,54,t)}},V=class extends w{static{i(this,"DoubleTrappedChestContainer")}constructor(t){super(p.BlockIdentifier.TrappedChest,d.ContainerType.Container,54,t)}};var S=class{static{i(this,"MOVEABLE")}},x=class{static{i(this,"IMMOVEABLE")}},K;(o=>{function r(n,e){switch(n){case 0:return new D(e);case 1:return new B(e);case 2:return new L(e);case 3:return new V(e);case 4:return new N(e);case 5:return new A(e);case 6:return new y(e);case 7:return new E(e);case 16:return new H(e);case 10:return new R(e);case 15:return new $(e);case 14:return new T(e);case 9:return new q(e);case 12:return new G(e);case 8:return new O(e);case 11:return new M(e);case 13:return new z(e);default:throw new Error(`Container type ${n} is not supported.`)}}o.create=r,i(r,"create");function t(n){let e={sourceSlot:void 0,destinationSlot:void 0,data:void 0};switch(n.action){case v.ItemStackRequestActionType.Place:case v.ItemStackRequestActionType.Take:e.sourceSlot=n.takeOrPlace?.source.slot,e.destinationSlot=n.takeOrPlace?.destination.slot,e.data=n.takeOrPlace;break;case v.ItemStackRequestActionType.Swap:e.sourceSlot=n.swap?.source.slot,e.destinationSlot=n.swap?.destination.slot,e.data=n.swap;break;case v.ItemStackRequestActionType.Drop:e.sourceSlot=n.drop?.source.slot,e.data=n.drop;break}return e}o.getSlot=t,i(t,"getSlot")})(K||={});var f=require("@serenityjs/protocol"),F=require("@serenityjs/core");var Q;(t=>{function r(o){o.network.before(f.Packet.ItemStackRequest,n=>{if(m.hasContainer(n.connection)){let e=o.getPlayerByConnection(n.connection),{container:c}=m.getContainer(e.connection),u=new f.ItemStackResponsePacket;u.responses=[];for(let s of n.packet.requests)for(let k of s.actions){let h=f.ItemStackStatus.Error,U=c.callTransactionCallback(k,e);u.responses.push({id:s.clientRequestId,status:h})}e.send(u)}return!0}),o.network.on(f.Packet.ContainerClose,({connection:n,bound:e})=>{if(e==F.NetworkBound.Server&&m.hasContainer(n)){let c=o.getPlayerByConnection(n),{container:u}=m.getContainer(n);u.closeContainer(c,!1)}}),o.network.on(f.Packet.Disconnect,({connection:n})=>{if(m.hasContainer(n)){let{container:e}=m.getContainer(n);e.callCloseCallback(),m.removeContainer(n)}})}t.loadListeners=r,i(r,"loadListeners")})(Q||={});var X=class extends j.Plugin{static{i(this,"ContainerMenu_Plugin")}type=j.PluginType.Api;constructor(){super("container-menu","1.0.0")}onInitialize(t){Q.loadListeners(t.serenity)}},st=new X;
