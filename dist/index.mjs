var Z=Object.defineProperty;var r=(i,t)=>Z(i,"name",{value:t,configurable:!0});import{Plugin as ht,PluginType as kt}from"@serenityjs/plugins";import{ItemStackRequestActionType as H}from"@serenityjs/protocol";import{BlockIdentifier as u}from"@serenityjs/core";import{BlockActorDataPacket as _,BlockPosition as F,ContainerClosePacket as tt,ContainerId as et,ContainerName as nt,ContainerOpenPacket as ot,FullContainerName as rt,InventoryContentPacket as it,NetworkItemStackDescriptor as st,UpdateBlockFlagsType as at,UpdateBlockPacket as K}from"@serenityjs/protocol";import{BlockPermutation as Q,ItemStack as X,ItemIdentifier as ct}from"@serenityjs/core";import{CompoundTag as lt,StringTag as ut}from"@serenityjs/nbt";import{Player as I}from"@serenityjs/core";var d;(l=>{l.containerMap=new Map;function t(s,f){s instanceof I&&(s=s.connection),l.containerMap.set(s,f)}l.setContainer=t,r(t,"setContainer");function o(){return Array.from(l.containerMap.values())}l.getAllContainers=o,r(o,"getAllContainers");function n(s){s instanceof I&&(s=s.connection),l.containerMap.delete(s)}l.removeContainer=n,r(n,"removeContainer");function e(s){return s instanceof I&&(s=s.connection),l.containerMap.get(s)}l.getContainer=e,r(e,"getContainer");function a(s){return s instanceof I&&(s=s.connection),l.containerMap.has(s)}l.hasContainer=a,r(a,"hasContainer")})(d||={});function z(i){let t=i.position;return new F(Math.floor(t.x),Math.floor(t.y+2),Math.floor(t.z))}r(z,"getAbovePosition");var c=class{static{r(this,"FakeContainer")}blockIdentifier;containerId=et.None;containerType;containerSize;inventory;customName;transactionCallback;containerCloseCallback;constructor(t,o,n,e={}){this.blockIdentifier=t,this.containerType=o,this.containerSize=n,this.inventory=e}show(t){if(d.hasContainer(t))throw Error("Player Already Has A Fake Container Open");let o=z(t);this.placeContainer(t,o),this.customName&&this.sendCustomName(t,o),this.openContainer(t,o),t.world.schedule(1).on(()=>this.update(t))}setItem(t,o){if(t<0||t>=this.containerSize)throw new Error(`Slot ${t} is out of range (container has ${this.containerSize} slots)`);this.inventory[t]=o}getItem(t){if(t<0||t>=this.containerSize)throw new Error(`Slot ${t} is out of range (container has ${this.containerSize} slots)`);return this.inventory[t]}addItem(t){for(let o=0;o<this.containerSize;o++)if(!this.inventory[o]){this.setItem(o,t);return}}clearItem(t){if(t<0||t>=this.containerSize)throw new Error(`Slot ${t} is out of range (container has ${this.containerSize} slots)`);this.inventory[t]&&delete this.inventory[t]}setContents(t){for(let[o,n]of Object.entries(t))this.setItem(+o,n)}getContents(){return this.inventory}clearContents(){for(let[t,o]of Object.entries(this.inventory))this.clearItem(+t)}update(t){if(!d.hasContainer(t))throw Error("Player Doesnt Have A Fake Container Open");let o=[];for(let e=0;e<this.containerSize;e++){let a=this.inventory[e]??new X(ct.Air),l=X.toNetworkStack(a);o.push(l)}let n=new it;n.containerId=this.containerId,n.items=o,n.fullContainerName=new rt(nt.Container),n.storageItem=new st(0),t.send(n)}destroyContainer(t,o){let n=t.dimension.getBlock(o),e=Q.resolve(n.type.identifier).networkId,a=new K;a.position=o,a.networkBlockId=e,a.flags=at.Network,a.layer=0,a.offset=0,t.send(a)}placeContainer(t,o){let n=Q.resolve(this.blockIdentifier).networkId,e=new K;e.position=o,e.networkBlockId=n,e.flags=0,e.layer=0,e.offset=0,t.send(e)}openContainer(t,o){let n=new ot;n.identifier=this.containerId,n.type=this.containerType,n.position=o,n.uniqueId=-1n,t.send(n),d.setContainer(t,{blockPos:o,container:this})}closeContainer(t,o=!0){if(!d.hasContainer(t))throw Error("Player Doesnt Have A Fake Container Open");let n=d.getContainer(t),e=new tt;e.identifier=this.containerId,e.serverInitiated=o,e.type=this.containerType,t.send(e),t.world.schedule(1).on(()=>this.destroyContainer(t,n.blockPos)),this.callCloseCallback(t),d.removeContainer(t)}sendCustomName(t,o){let n=new _;n.position=o;let e=new ut({name:"CustomName",value:this.customName});n.nbt||(n.nbt=new lt),n.nbt.addTag(e),t.send(n)}setCustomName(t){this.customName=t}getCustomName(){return this.customName}onTransaction(t){this.transactionCallback=t}callTransactionCallback(t,o){if(this.transactionCallback!==void 0)return this.transactionCallback({action:t,player:o})}onClose(t){this.containerCloseCallback=t}callCloseCallback(t){this.containerCloseCallback!==void 0&&this.containerCloseCallback(t)}};import{BlockActorDataPacket as pt}from"@serenityjs/protocol";import{ByteTag as dt,CompoundTag as mt,IntTag as Y,StringTag as ft}from"@serenityjs/nbt";var b=class extends c{static{r(this,"FakeDoubleContainer")}constructor(t,o,n,e={}){super(t,o,n,e)}show(t){let o=z(t),n=o;n.x+=1,this.placeContainer(t,o),this.placeContainer(t,n),this.sendNbtData(t,[o,n],!0),this.sendNbtData(t,[o,n],!1),this.openContainer(t,o),t.world.schedule(1).on(()=>this.update(t))}sendNbtData(t,o,n=!1){let e=new pt;e.position=n?o[0]:o[1];let a={};e.nbt||(e.nbt=new mt);let l=this.getCustomName();l&&(a.CustomName=new ft({name:"CustomName",value:l})),a.pairlead=new dt({name:"pairlead",value:n?1:0}),a.pairx=new Y({name:"pairx",value:o[0].x}),a.pairz=new Y({name:"pairz",value:o[1].z});for(let[s,f]of Object.entries(a))e.nbt.addTag(f);t.send(e)}destroyContainer(t,o){let n=o,e=n;e.x+=1,this.destroyContainer(t,n),this.destroyContainer(t,e)}};import{ContainerType as p}from"@serenityjs/protocol";var w=class extends c{static{r(this,"TrappedChestContainer")}constructor(t){super(u.TrappedChest,p.Container,27,t)}},v=class extends c{static{r(this,"ChestContainer")}constructor(t){super(u.Chest,p.Container,27,t)}},S=class extends c{static{r(this,"DispenserContainer")}constructor(t){super(u.Dispenser,p.Dispenser,9,t)}},x=class extends c{static{r(this,"DropperContainer")}constructor(t){super(u.Dropper,p.Dropper,9,t)}},P=class extends c{static{r(this,"EnchantingContainer")}constructor(t){super(u.EnchantingTable,p.Enchantment,2,t)}},g=class extends c{static{r(this,"HopperContainer")}constructor(t){super(u.Hopper,p.Hopper,5,t)}},B=class extends c{static{r(this,"CraftingContainer")}constructor(t){super(u.CraftingTable,p.Workbench,10,t)}},D=class extends c{static{r(this,"SmithingContainer")}constructor(t){super(u.SmithingTable,p.SmithingTable,4,t)}},y=class extends c{static{r(this,"FurnaceContainer")}constructor(t){super(u.Furnace,p.Furnace,3,t)}},A=class extends c{static{r(this,"SmokerContainer")}constructor(t){super(u.Smoker,p.Smoker,3,t)}},E=class extends c{static{r(this,"BlastFurnaceContainer")}constructor(t){super(u.BlastFurnace,p.BlastFurnace,3,t)}},N=class extends c{static{r(this,"AnvilContainer")}constructor(t){super(u.Anvil,p.Anvil,3,t)}},T=class extends c{static{r(this,"BrewingStandContainer")}constructor(t){super(u.BrewingStand,p.BrewingStand,5,t)}},O=class extends c{static{r(this,"GrindstoneContainer")}constructor(t){super(u.Grindstone,p.Grindstone,3,t)}},q=class extends c{static{r(this,"StonecutterContainer")}constructor(t){super(u.Stonecutter,p.Stonecutter,2,t)}},M=class extends b{static{r(this,"DoubleChestContainer")}constructor(t){super(u.Chest,p.Container,54,t)}},R=class extends b{static{r(this,"DoubleTrappedChestContainer")}constructor(t){super(u.TrappedChest,p.Container,54,t)}};var h=class{static{r(this,"MOVEABLE")}},k=class{static{r(this,"IMMOVEABLE")}},L;(o=>{function i(n,e){switch(n){case 0:return new v(e);case 1:return new w(e);case 2:return new M(e);case 3:return new R(e);case 4:return new g(e);case 5:return new x(e);case 6:return new S(e);case 7:return new P(e);case 16:return new N(e);case 10:return new E(e);case 15:return new T(e);case 14:return new B(e);case 9:return new y(e);case 12:return new O(e);case 8:return new D(e);case 11:return new A(e);case 13:return new q(e);default:throw new Error(`Container type ${n} is not supported.`)}}o.create=i,r(i,"create");function t(n){let e={sourceSlot:void 0,destinationSlot:void 0,data:void 0};switch(n.action){case H.Place:case H.Take:e.sourceSlot=n.takeOrPlace?.source.slot,e.destinationSlot=n.takeOrPlace?.destination.slot,e.data=n.takeOrPlace;break;case H.Swap:e.sourceSlot=n.swap?.source.slot,e.destinationSlot=n.swap?.destination.slot,e.data=n.swap;break;case H.Drop:e.sourceSlot=n.drop?.source.slot,e.data=n.drop;break}return e}o.getSlot=t,r(t,"getSlot")})(L||={});import{ItemStackResponsePacket as Ct,ItemStackStatus as C,Packet as V}from"@serenityjs/protocol";import{NetworkBound as bt}from"@serenityjs/core";var j;(t=>{function i(o){o.network.before(V.ItemStackRequest,n=>{if(d.hasContainer(n.connection)){let e=o.getPlayerByConnection(n.connection),{container:a}=d.getContainer(e.connection),l=new Ct;l.responses=[];for(let s of n.packet.requests)for(let f of s.actions){let m=C.Error,$=a.callTransactionCallback(f,e);l.responses.push({id:s.clientRequestId,status:m})}e.send(l)}return!0}),o.network.on(V.ContainerClose,({connection:n,bound:e})=>{if(e==bt.Server&&d.hasContainer(n)){let a=o.getPlayerByConnection(n),{container:l}=d.getContainer(n);l.closeContainer(a,!1)}}),o.network.on(V.Disconnect,({connection:n})=>{if(d.hasContainer(n)){let{container:e}=d.getContainer(n);e.callCloseCallback(),d.removeContainer(n)}})}t.loadListeners=i,r(i,"loadListeners")})(j||={});var U=class extends ht{static{r(this,"ContainerMenu_Plugin")}type=kt.Api;constructor(){super("container-menu","1.0.0")}onInitialize(t){j.loadListeners(t.serenity)}},ue=new U;export{ue as default};
